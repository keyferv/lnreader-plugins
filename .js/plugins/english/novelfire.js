var e,t=this&&this.__extends||(e=function(t,a){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])},e(t,a)},function(t,a){if("function"!=typeof a&&null!==a)throw new TypeError("Class extends value "+String(a)+" is not a constructor or null");function r(){this.constructor=t}e(t,a),t.prototype=null===a?Object.create(a):(r.prototype=a.prototype,new r)}),a=this&&this.__assign||function(){return a=Object.assign||function(e){for(var t,a=1,r=arguments.length;a<r;a++)for(var n in t=arguments[a])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},a.apply(this,arguments)},r=this&&this.__awaiter||function(e,t,a,r){return new(a||(a=Promise))((function(n,l){function s(e){try{i(r.next(e))}catch(e){l(e)}}function o(e){try{i(r.throw(e))}catch(e){l(e)}}function i(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(s,o)}i((r=r.apply(e,t||[])).next())}))},n=this&&this.__generator||function(e,t){var a,r,n,l={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(i){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(l=0)),l;)try{if(a=1,r&&(n=2&o[0]?r.return:o[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,o[1])).done)return n;switch(r=0,n&&(o=[2&o[0],n.value]),o[0]){case 0:case 1:n=o;break;case 4:return l.label++,{value:o[1],done:!1};case 5:l.label++,r=o[1],o=[0];continue;case 7:o=l.ops.pop(),l.trys.pop();continue;default:if(!(n=l.trys,(n=n.length>0&&n[n.length-1])||6!==o[0]&&2!==o[0])){l=0;continue}if(3===o[0]&&(!n||o[1]>n[0]&&o[1]<n[3])){l.label=o[1];break}if(6===o[0]&&l.label<n[1]){l.label=n[1],n=o;break}if(n&&l.label<n[2]){l.label=n[2],l.ops.push(o);break}n[2]&&l.ops.pop(),l.trys.pop();continue}o=t.call(e,l)}catch(e){o=[6,e],r=0}finally{a=n=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,i])}}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("cheerio"),s=require("@libs/fetch"),o=require("@libs/novelStatus"),i=require("@libs/filterInputs"),u=function(){function e(){this.id="novelfire",this.name="Novel Fire",this.version="1.0.20",this.icon="src/en/novelfire/icon.png",this.site="https://novelfire.net/",this.webStorageUtilized=!0,this.filters={sort:{label:"Sort Results By",value:"rank-top",options:[{label:"Rank (Top)",value:"rank-top"},{label:"Rating Score (Top)",value:"rating-score-top"},{label:"Bookmark Count (Most)",value:"bookmark"},{label:"Review Count (Most)",value:"review"},{label:"Title (A>Z)",value:"abc"},{label:"Title (Z>A)",value:"cba"},{label:"Last Updated (Newest)",value:"date"},{label:"Chapter Count (Most)",value:"chapter-count-most"}],type:i.FilterTypes.Picker},status:{label:"Translation Status",value:"-1",options:[{label:"All",value:"-1"},{label:"Completed",value:"1"},{label:"Ongoing",value:"0"}],type:i.FilterTypes.Picker},genre_operator:{label:"Genres (And/Or)",value:"and",options:[{label:"And",value:"and"},{label:"Or",value:"or"}],type:i.FilterTypes.Picker},genres:{label:"Genres",value:[],options:[{label:"Action",value:"3"},{label:"Adult",value:"28"},{label:"Adventure",value:"4"},{label:"Anime",value:"46"},{label:"Arts",value:"47"},{label:"Comedy",value:"5"},{label:"Drama",value:"24"},{label:"Eastern",value:"44"},{label:"Ecchi",value:"26"},{label:"Fan-fiction",value:"48"},{label:"Fantasy",value:"6"},{label:"Game",value:"19"},{label:"Gender Bender",value:"25"},{label:"Harem",value:"7"},{label:"Historical",value:"12"},{label:"Horror",value:"37"},{label:"Isekai",value:"49"},{label:"Josei",value:"2"},{label:"Lgbt+",value:"45"},{label:"Magic",value:"50"},{label:"Magical Realism",value:"51"},{label:"Manhua",value:"52"},{label:"Martial Arts",value:"15"},{label:"Mature",value:"8"},{label:"Mecha",value:"34"},{label:"Military",value:"53"},{label:"Modern Life",value:"54"},{label:"Movies",value:"55"},{label:"Mystery",value:"16"},{label:"Psychological",value:"9"},{label:"Realistic Fiction",value:"56"},{label:"Reincarnation",value:"43"},{label:"Romance",value:"1"},{label:"School Life",value:"21"},{label:"Sci-fi",value:"20"},{label:"Seinen",value:"10"},{label:"Shoujo",value:"38"},{label:"Shoujo Ai",value:"57"},{label:"Shounen",value:"17"},{label:"Shounen Ai",value:"39"},{label:"Slice of Life",value:"13"},{label:"Smut",value:"29"},{label:"Sports",value:"42"},{label:"Supernatural",value:"18"},{label:"System",value:"58"},{label:"Tragedy",value:"32"},{label:"Urban",value:"63"},{label:"Urban Life",value:"59"},{label:"Video Games",value:"60"},{label:"War",value:"61"},{label:"Wuxia",value:"31"},{label:"Xianxia",value:"23"},{label:"Xuanhuan",value:"22"},{label:"Yaoi",value:"14"},{label:"Yuri",value:"62"}],type:i.FilterTypes.CheckboxGroup},language:{label:"Language",value:[],options:[{label:"Chinese",value:"1"},{label:"Korean",value:"2"},{label:"Japanese",value:"3"},{label:"English",value:"4"}],type:i.FilterTypes.CheckboxGroup},rating_operator:{label:"Rating (Min/Max)",value:"min",options:[{label:"Min",value:"min"},{label:"Max",value:"max"}],type:i.FilterTypes.Picker},rating:{label:"Rating",value:"0",options:[{label:"All",value:"0"},{label:"1",value:"1"},{label:"2",value:"2"},{label:"3",value:"3"},{label:"4",value:"4"},{label:"5",value:"5"}],type:i.FilterTypes.Picker},chapters:{label:"Chapters",value:"0",options:[{label:"All",value:"0"},{label:"<50",value:"1,49"},{label:"50-100",value:"50,100"},{label:"100-200",value:"100,200"},{label:"200-500",value:"200,500"},{label:"500-1000",value:"500,1000"},{label:">1000",value:"1001,1000000"}],type:i.FilterTypes.Picker}}}return e.prototype.requestHeaders=function(e){var t={Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"en-US,en;q=0.9,*;q=0.8","Upgrade-Insecure-Requests":"1"};return e&&(t.Referer=e),t},e.prototype.ajaxHeaders=function(e){return a(a({},this.requestHeaders(e)),{Accept:"application/json, text/javascript, */*; q=0.01","X-Requested-With":"XMLHttpRequest"})},e.prototype.fetchWithHeaders=function(e,t){return r(this,void 0,void 0,(function(){return n(this,(function(a){switch(a.label){case 0:return[4,(0,s.fetchApi)(e,{headers:this.requestHeaders(t)})];case 1:return[2,a.sent()]}}))}))},e.prototype.fetchAjax=function(e,t){return r(this,void 0,void 0,(function(){return n(this,(function(a){switch(a.label){case 0:return[4,(0,s.fetchApi)(e,{headers:this.ajaxHeaders(t)})];case 1:return[2,a.sent()]}}))}))},e.prototype.detectBlockReason=function(e){},e.prototype.inferChaptersRefererFromPath=function(e){var t=this.resolveAbsUrl(e,this.site);try{var a=new URL(t).pathname.split("/").filter(Boolean);return"book"===a[0]&&a[1]?"".concat(this.site,"book/").concat(a[1],"/chapters"):this.site}catch(e){return this.site}},e.prototype.resolveAbsUrl=function(e,t){try{return new URL(e,t).toString()}catch(t){return e}},e.prototype.toPath=function(e){return e.replace(this.site,"").replace(/^\//,"")},e.prototype.normalizePath=function(e,t){return this.toPath(this.resolveAbsUrl(e,t))},e.prototype.extractPostIdFromChaptersHtml=function(e){var t,a,r=null===(t=e.match(/listChapterDataAjax\?[^"'<>]*post_id=(\d+)/i))||void 0===t?void 0:t[1];return r||(null===(a=e.match(/\bpost_id\b\s*[:=]\s*["']?(\d+)["']?/i))||void 0===a?void 0:a[1])},e.prototype.extractChapterItemsFromAjaxPayload=function(e,t){var a,r=this,n=[],s=new Set,o=function(e,a){if(a){var l=r.resolveAbsUrl(a,t),o=r.toPath(l);o&&!s.has(o)&&(s.add(o),n.push({name:(e||"").trim()||"No Title Found",path:o}))}},i=function(e){var t=(0,l.load)(e)("a[href]").first();if(t.length){var a=t.attr("href"),r=t.text().trim()||t.attr("title")||void 0;o(r,a)}},u=function(e){var t,a,r;if(null!=e)if("string"!=typeof e){if(Array.isArray(e))for(var n=0,l=e;n<l.length;n++){var s=l[n];u(s)}else if("object"==typeof e){var c=null!==(a=null!==(t=e.href)&&void 0!==t?t:e.url)&&void 0!==a?a:e.link,h=null!==(r=e.title)&&void 0!==r?r:e.name;c&&o(h,c);for(var p=0,v=Object.values(e);p<v.length;p++){"string"==typeof(s=v[p])&&s.includes("<a")&&s.includes("href=")?i(s):u(s)}}}else e.includes("<a")&&e.includes("href=")&&i(e)};return u(null!==(a=null==e?void 0:e.data)&&void 0!==a?a:e),n},e.prototype.getCheerio=function(e,t){return r(this,void 0,void 0,(function(){var a,r;return n(this,(function(n){switch(n.label){case 0:return[4,this.fetchWithHeaders(e,this.site)];case 1:if(!(a=n.sent()).ok&&1!=t)throw new Error("Could not reach site ("+a.status+").");return[4,a.text()];case 2:return r=n.sent(),[2,(0,l.load)(r)]}}))}))},e.prototype.popularNovels=function(e,t){return r(this,arguments,void 0,(function(e,t){var a,r,l,s,o,i,u,c,h,p=this,v=t.showLatestNovels,f=t.filters;return n(this,(function(t){switch(t.label){case 0:if(a="",v)a="".concat(this.site,"latest-release-novels?page=").concat(e);else if(f){for(a=this.site+"search-adv",r=new URLSearchParams,l=0,s=f.language.value;l<s.length;l++)o=s[l],r.append("country_id[]",o);for(r.append("ctgcon",f.genre_operator.value),i=0,u=f.genres.value;i<u.length;i++)c=u[i],r.append("categories[]",c);r.append("totalchapter",f.chapters.value),r.append("ratcon",f.rating_operator.value),r.append("rating",f.rating.value),r.append("status",f.status.value),r.append("sort",f.sort.value),r.append("page",e.toString()),a+="?".concat(r.toString())}else a="".concat(this.site,"search-adv?ctgcon=and&totalchapter=0&ratcon=min&rating=0&status=-1&sort=rank-top&page=").concat(e);return[4,this.getCheerio(a,!1)];case 1:return[2,(h=t.sent())(v?".novel-list.horizontal .novel-item":".novel-item").map((function(e,t){var r=v?h(t).find(".novel-title").text().trim()||h(t).find(".novel-title > a").attr("title")||"No Title Found":h(t).find(".novel-title > a").attr("title")||h(t).find(".novel-title > a").text().trim()||h(t).find(".title > a").attr("title")||h(t).find(".title > a").text().trim()||h(t).find("h2.title a").text().trim()||h(t).find("a").attr("title")||"No Title Found",n=h(t).find(".novel-cover img").attr("data-src")||h(t).find(".novel-cover img").attr("src")||h(t).find(".cover img").attr("data-src")||h(t).find(".cover img").attr("src")||h(t).find("img").attr("data-src")||h(t).find("img").attr("src");n&&(n=p.resolveAbsUrl(n,a));var l=h(t).find(".novel-title > a").attr("href")||h(t).find(".cover-wrap > a").attr("href")||h(t).find("a").attr("href");if(!l)return null;var s=p.normalizePath(l,a);return s?{name:r,cover:n,path:s}:null})).get().filter((function(e){return null!==e}))]}}))}))},e.prototype.parseChapters=function(e,t){return r(this,void 0,void 0,(function(){var a,s,o,i,u,h,p,v,f,d,b,m,g,y,x,w,P,A,S,C,k,F,_,N,U,T,j,R,M,H,L,q,O,I,E,W,G,z,B,D,X,Y,$,J,Z,K,V,Q=this;return n(this,(function(ee){switch(ee.label){case 0:a=Array.from({length:Math.max(1,t)},(function(e,t){return t+1})),s=[],o=this.resolveAbsUrl(e,this.site),i=o,ee.label=1;case 1:return ee.trys.push([1,16,,17]),[4,this.fetchWithHeaders(o,i)];case 2:return[4,ee.sent().text()];case 3:return u=ee.sent(),h=(0,l.load)(u),(p=h(".chapter-latest-container").attr("href"))?(o=this.resolveAbsUrl(p,o),[4,this.fetchWithHeaders(o,i)]):[3,6];case 4:return[4,ee.sent().text()];case 5:u=ee.sent(),h=(0,l.load)(u),ee.label=6;case 6:if((v=h("#gotochapno").attr("max"))&&(f=parseInt(v,10),!isNaN(f)&&f>0)){for(J=[],d=e.replace(/\/chapters\/?$/,"").replace(/\/$/,""),I=1;I<=f;I++)J.push({name:"Chapter ".concat(I),path:"".concat(d,"/chapter-").concat(I)});return[2,J]}if((b=parseInt(h("#gotochapno").attr("max")||"0",10))>0&&(m=Math.ceil(b/20))>a.length&&(a=Array.from({length:m},(function(e,t){return t+1}))),!(g=this.extractPostIdFromChaptersHtml(u)))return[3,15];y=new URL(this.resolveAbsUrl("/listChapterDataAjax",this.site)),x=1,w=0,P=20,A=[],S=new Set,C=0,ee.label=7;case 7:return C<500?(y.search="",y.searchParams.set("post_id",g),y.searchParams.set("draw",String(x++)),y.searchParams.set("start",String(w)),y.searchParams.set("length",String(P)),y.searchParams.set("order[0][column]","2"),y.searchParams.set("order[0][dir]","asc"),y.searchParams.set("columns[0][data]","title"),y.searchParams.set("columns[0][name]",""),y.searchParams.set("columns[0][searchable]","true"),y.searchParams.set("columns[0][orderable]","false"),y.searchParams.set("columns[0][search][value]",""),y.searchParams.set("columns[0][search][regex]","false"),y.searchParams.set("columns[1][data]","created_at"),y.searchParams.set("columns[1][name]",""),y.searchParams.set("columns[1][searchable]","true"),y.searchParams.set("columns[1][orderable]","true"),y.searchParams.set("columns[1][search][value]",""),y.searchParams.set("columns[1][search][regex]","false"),y.searchParams.set("columns[2][data]","n_sort"),y.searchParams.set("columns[2][name]",""),y.searchParams.set("columns[2][searchable]","false"),y.searchParams.set("columns[2][orderable]","true"),y.searchParams.set("columns[2][search][value]",""),y.searchParams.set("columns[2][search][regex]","false"),y.searchParams.set("search[value]",""),y.searchParams.set("search[regex]","false"),y.searchParams.set("_",String(Date.now())),[4,this.fetchAjax(y.toString(),i)]):[3,14];case 8:return(k=ee.sent()).ok?(F=(k.headers.get("content-type")||"").toLowerCase(),_=null,F.includes("application/json")?[4,k.json().catch((function(){return null}))]:[3,10]):[3,14];case 9:return _=ee.sent(),[3,12];case 10:return[4,k.text().catch((function(){return""}))];case 11:ee.sent(),_=null,ee.label=12;case 12:if(!_)return[3,14];for(N=this.extractChapterItemsFromAjaxPayload(_,i),U=0,T=0,j=N;T<j.length;T++)(null==(V=j[T])?void 0:V.path)&&!S.has(V.path)&&(S.add(V.path),A.push(V),U++);if(R="number"==typeof _.recordsTotal?_.recordsTotal:"number"==typeof _.recordsFiltered?_.recordsFiltered:void 0,w+=P,null!=R&&w>=R)return[3,14];if(0===U)return[3,14];ee.label=13;case 13:return C++,[3,7];case 14:if(A.length)return[2,A];ee.label=15;case 15:return[3,17];case 16:return ee.sent(),[3,17];case 17:M=function(e){return r(Q,void 0,void 0,(function(){var t,a,r,s,i,u=this;return n(this,(function(n){switch(n.label){case 0:return t="".concat(o).concat(o.includes("?")?"&":"?","page=").concat(e),[4,this.fetchWithHeaders(t,o)];case 1:return[4,n.sent().text()];case 2:if(a=n.sent(),(r=(0,l.load)(a)).text().includes("You are being rate limited"))throw new c;return s=[],i=new Set,r("#listChapter-table tbody tr td a[href]").each((function(e,a){var n=r(a).attr("href");if(n){var l=u.resolveAbsUrl(n,t),o=u.toPath(l);if(o&&!i.has(o)){var c=r(a).text().trim()||r(a).attr("title")||"No Title Found";i.add(o),s.push({name:c,path:o})}}})),s.length||r(".chapter-list li a[href]").each((function(e,a){var n=r(a).attr("href");if(n){var l=u.resolveAbsUrl(n,t),o=u.toPath(l);if(o&&!i.has(o)){var c=r(a).attr("title")||r(a).text().trim()||"No Title Found";i.add(o),s.push({name:c,path:o})}}})),[2,s]}}))}))},H=5,L=10,q=3.5,O=[],I=0,ee.label=18;case 18:if(!(I<a.length))return[3,28];E=a.slice(I,I+H),W=E[0],G=E[E.length-1],z=0,ee.label=19;case 19:if(!(z<L))return[3,27];ee.label=20;case 20:return ee.trys.push([20,22,,26]),[4,Promise.all(E.map(M))];case 21:return B=ee.sent(),O.push.apply(O,B),[3,27];case 22:if(!((D=ee.sent())instanceof c))return[3,24];if(z+=1,console.warn("[pages=".concat(W,"-").concat(G,"] Novel Fire is rate limiting requests. Retry attempt ").concat(z+1," in ").concat(q," seconds...")),z===L)throw D;return[4,new Promise((function(e){return setTimeout(e,1e3*q)}))];case 23:return ee.sent(),[3,25];case 24:throw D;case 25:return[3,26];case 26:return[3,19];case 27:return I+=H,[3,18];case 28:for(X=new Set,Y=0,$=O;Y<$.length;Y++){for(J=$[Y],Z=0,K=J;Z<K.length;Z++)(null==(V=K[Z])?void 0:V.path)&&!X.has(V.path)&&(X.add(V.path),s.push(V));if(0===J.length)break}if(0===s.length)throw new Error("Could not parse chapters page.");return[2,s]}}))}))},e.prototype.parseNovel=function(e){return r(this,void 0,void 0,(function(){var t,a,r,l,s,i,u,c,h,p,v,f,d,b,m,g,y,x;return n(this,(function(n){switch(n.label){case 0:return t=this.resolveAbsUrl(e,this.site),[4,this.getCheerio(t,!1)];case 1:return a=n.sent(),r=this.site,(l={path:e}).name=null!==(g=null!==(m=a(".novel-title").text().trim())&&void 0!==m?m:a(".cover > img").attr("alt"))&&void 0!==g?g:"No Titled Found",(s=null!==(y=a(".cover > img").attr("data-src"))&&void 0!==y?y:a(".cover > img").attr("src"))&&(l.cover=new URL(s,r).href),l.genres=a(".categories .property-item").map((function(e,t){return a(t).text()})).toArray().join(","),(i=a(".summary .content").text().trim())?(i=i.replace("Show More",""),l.summary=i):l.summary="No Summary Found",l.author=a(".author .property-item > span").text()||"No Author Found",u=a(".header-stats .ongoing").text()||a(".header-stats .completed").text()||"Unknown",c={ongoing:o.NovelStatus.Ongoing,hiatus:o.NovelStatus.OnHiatus,dropped:o.NovelStatus.Cancelled,cancelled:o.NovelStatus.Cancelled,completed:o.NovelStatus.Completed,unknown:o.NovelStatus.Unknown},l.status=null!==(x=c[u.toLowerCase()])&&void 0!==x?x:o.NovelStatus.Unknown,h=a(".header-stats .icon-book-open").parent().text().trim(),p=a("a.grdbtn.chapter-latest-container[href], a.chapter-latest-container[href]").first().attr("href"),v=p?this.toPath(this.resolveAbsUrl(p,t)):"".concat(this.toPath(t).replace(/\/$/,""),"/chapters"),f=parseInt((h||"").replace(/[^0-9]/g,""),10),d=f?Math.ceil(f/100):1,b=l,[4,this.parseChapters(v,d)];case 2:return b.chapters=n.sent(),[2,l]}}))}))},e.prototype.parseChapter=function(e){return r(this,void 0,void 0,(function(){var t,a,r,s,o;return n(this,(function(n){switch(n.label){case 0:return t=this.resolveAbsUrl(e,this.site),a=this.inferChaptersRefererFromPath(t),[4,this.fetchWithHeaders(t,a)];case 1:return[4,n.sent().text()];case 2:if(r=n.sent(),s=(0,l.load)(r),[".box-ads",".box-notification",/^nf/].forEach((function(e){e instanceof RegExp?s("*").filter((function(t,a){return e.test(s(a).prop("tagName").toLowerCase())})).remove():s(e).remove()})),!(o=s("#content").html()||s(".chapter-content").html()||s("article").html()))throw new Error("Could not parse chapter content.");return[2,o]}}))}))},e.prototype.searchNovels=function(e,t){return r(this,void 0,void 0,(function(){var a,r,s,o=this;return n(this,(function(n){switch(n.label){case 0:return a="".concat(this.site,"search?keyword=").concat(encodeURIComponent(e),"&page=").concat(t),[4,this.fetchWithHeaders(a,this.site)];case 1:return[4,n.sent().text()];case 2:return r=n.sent(),[2,(s=(0,l.load)(r))(".novel-list.chapters .novel-item").map((function(e,t){var r=s(t).find("a").attr("title")||"No Title Found",n=s(t).find(".novel-cover > img").attr("src"),l=s(t).find("a").attr("href");if(!l)return null;var i=o.normalizePath(l,a);return i?{name:r,cover:n,path:i}:null})).get().filter((function(e){return null!==e}))]}}))}))},e}();exports.default=new u;var c=function(e){function a(t){void 0===t&&(t="Novel Fire is rate limiting requests");var a=e.call(this,t)||this;return a.name="NovelFireError",a}return t(a,e),a}(Error);