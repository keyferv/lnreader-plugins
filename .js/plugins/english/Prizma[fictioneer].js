var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}c((r=r.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@libs/fetch"),i=require("@libs/novelStatus"),o=require("htmlparser2"),a=n(require("dayjs"));var s=new(function(){function n(e){this.id=e.id,this.name=e.sourceName,this.icon="multisrc/ifreedom/".concat(e.id.toLowerCase(),"/icon.png"),this.site=e.sourceSite,this.version="1.1.0",this.filters=e.filters}return n.prototype.parseNovels=function(e){var t=this;return(0,r.fetchApi)(e).then((function(e){return e.text()})).then((function(e){var n=[],r={},i=!1,a=t.site,s=new o.Parser({onopentag:function(e,t){var n=t.class||"";"div"===e&&(n.includes("one-book-home")||n.includes("item-book-slide"))&&(i=!0),i&&("img"===e&&(r.cover=t.src,t.alt&&(r.name=t.alt)),"a"===e&&t.href&&(r.path=t.href.replace(a,""),t.title&&(r.name=t.title)))},onclosetag:function(e){"div"===e&&i&&(i=!1,r.path&&n.push(r),r={})}});return s.write(e),s.end(),n}))},n.prototype.popularNovels=function(n,r){return e(this,arguments,void 0,(function(e,n){var r,i,o=n.filters,a=n.showLatestNovels;return t(this,(function(t){return r="".concat(this.site,"/vse-knigi/?sort=").concat(a?"По дате обновления":(null===(i=null==o?void 0:o.sort)||void 0===i?void 0:i.value)||"По рейтингу"),Object.entries(o||{}).forEach((function(e){var t=e[0],n=e[1].value;Array.isArray(n)&&n.length&&(r+="&".concat(t,"[]=").concat(n.join("&".concat(t,"[]="))))})),r+="&bpage=".concat(e),[2,this.parseNovels(r)]}))}))},n.prototype.parseNovel=function(n){return e(this,void 0,void 0,(function(){var e,s,c,u,l,h,f,p,d,v,m,g,b,y,w,k;return t(this,(function(t){switch(t.label){case 0:return[4,(0,r.fetchApi)(this.site+n).then((function(e){return e.text()}))];case 1:return e=t.sent(),s={path:n,name:"",author:"",summary:"",status:i.NovelStatus.Unknown},c=[],u=[],l=this.site,h=!1,f=!1,p=!1,d=null,v=!1,m=!1,g=!1,b=!1,y=!1,w={},k=new o.Parser({onopentag:function(e,t){var n=t.class||"";if("h1"===e&&(h=!0),"div"===e&&((n.includes("block-book-slide-img")||n.includes("img-ranobe"))&&(p=!0),("descr-ranobe"===n||"active"===n&&"Описание"===t["data-name"])&&(f=!0)),f&&"span"===e&&n.includes("open-desc")){var r=t.onclick;if(r){var i=r.match(/innerHTML\s*=\s*'([\s\S]+?)'/);if(i&&i[1]){var o=i[1];o=o.replace(/&lt;br&gt;/gi,"\n").replace(/<br\s*\/?>/gi,"\n").replace(/&quot;/g,'"').replace(/&#039;/g,"'").replace(/&amp;/g,"&"),s.summary=o,f=!1}}}"img"===e&&p&&!s.cover&&(s.cover=t.src),"div"===e&&(n.includes("data-ranobe")&&(v=!0,d=null),n.includes("data-value")&&(m=!0),n.includes("book-info-list")&&(v=!0,d=null),n.includes("genreslist")&&(d="genre")),v&&("span"===e&&(n.includes("dashicons-book")&&!n.includes("book-alt")?d="genre":n.includes("admin-users")?d="author":n.includes("megaphone")&&(d="status")),"svg"===e&&(n.includes("icon-tabler-tag")?d="genre":n.includes("mood-edit")||n.includes("icon-tabler-user")?d="author":(n.includes("chart-infographic")||n.includes("megaphone"))&&(d="status"))),"div"!==e||"li-ranobe"!==n&&"chapterinfo"!==n||(g=!0),"a"===e&&g&&(w.path=t.href.replace(l,""),b=!0),"div"!==e&&"span"!==e||"li-col2-ranobe"!==n&&"timechapter"!==n||(y=!0)},ontext:function(e){var t=e.trim();if(t){if(h&&(s.name=t.replace(/®/g,"").trim()),f&&"Прочесть полностью"!==t&&(s.summary+=t+"\n"),d)(m||v&&!m)&&("author"===d?"Автор"===t||"Переводчик"===t||"Не указан"===t||t.includes("Просмотров")||(s.author=t):"status"===d?t.includes("Статус")||(s.status=function(e){var t=e.toLowerCase().trim();if(t.includes("активен")||t.includes("продолжается")||t.includes("онгоинг"))return i.NovelStatus.Ongoing;if(t.includes("завершен")||t.includes("конец")||t.includes("закончен"))return i.NovelStatus.Completed;if(t.includes("приостановлен")||t.includes("заморожен"))return i.NovelStatus.OnHiatus;return i.NovelStatus.Unknown}(t)):"genre"===d&&","!==t&&"Жанры"!==t&&u.push(t));b&&(w.name=t),y&&(w.releaseTime=function(e){void 0===e&&(e="");var t={"января":1,"февраля":2,"марта":3,"апреля":4,"мая":5,"июня":6,"июля":7,"августа":8,"сентября":9,"октября":10,"ноября":11,"декабря":12},n=/(d+)s*ч.?s*назад/,r=e.match(n);if(r){var i=parseInt(r[1],10);return(0,a.default)().subtract(i,"hour").format("LL")}if(e.includes(".")){var o=e.split("."),s=o[0],c=o[1],u=2===(null==(h=o[2])?void 0:h.length)?"20"+h:h;return(0,a.default)(u+"-"+c+"-"+s).format("LL")}if(e.includes(" ")){var l=e.split(" ");s=l[0],c=l[1];if(s&&t[c]){var h=(new Date).getFullYear();return(0,a.default)(h+"-"+t[c]+"-"+s).format("LL")}}return e||null}(t))}},onclosetag:function(e){"h1"===e&&(h=!1),"div"===e&&(f&&(f=!1),p&&(p=!1),m&&(m=!1)),"a"===e&&(b=!1),"div"!==e&&"span"!==e||!y||(y=!1,w.path&&c.push(w),w={},g=!1)}}),k.write(e),k.end(),s.genres=u.join(","),s.chapters=c.reverse(),[2,s]}}))}))},n.prototype.parseChapter=function(n){return e(this,void 0,void 0,(function(){var e,i,o,a,s,c;return t(this,(function(t){switch(t.label){case 0:return[4,(0,r.fetchApi)(this.site+n).then((function(e){return e.text()}))];case 1:return e=t.sent(),i="bookhamster"===this.id?'<div class="entry-content">':'<div class="chapter-content">',o="bookhamster"===this.id?"\x3c!-- .entry-content --\x3e":'<div class="chapter-setting">',-1===(a=e.indexOf(i))?[2,""]:(s=e.indexOf(o,a),(c=(c=e.slice(a,-1!==s?s:void 0)).replace(/<script[^>]*>[\s\S]*?<\/script>/gim,"")).includes("<img")&&(c=c.replace(/srcset="([^"]+)"/g,(function(e,t){if(!t)return e;var n=t.split(" ").filter((function(e){return e.startsWith("http")})).pop();return n?'src="'.concat(n,'"'):e}))),[2,c])}}))}))},n.prototype.searchNovels=function(n){return e(this,arguments,void 0,(function(e,n){var r;return void 0===n&&(n=1),t(this,(function(t){return r="".concat(this.site,"/vse-knigi/?searchname=").concat(encodeURIComponent(e),"&bpage=").concat(n),[2,this.parseNovels(r)]}))}))},n}())({id:"prizmatranslation",sourceSite:"https://prizmatranslation.com",sourceName:"Prizma",options:{browsePage:"home/all-novels"}});exports.default=s;