var t=this&&this.__awaiter||function(t,e,r,n){return new(r||(r=Promise))((function(a,i){function o(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}c((n=n.apply(t,e||[])).next())}))},e=this&&this.__generator||function(t,e){var r,n,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(r=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],n=0}finally{r=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r=require("@libs/fetch"),n=require("cheerio"),a=require("@libs/defaultCover"),i=require("@libs/novelStatus"),o=new(function(){function o(){this.id="panchotranslations",this.name="Pancho Translations",this.icon="multisrc/madara/panchotranslations/icon.png",this.site="https://panchonovels.online/",this.version="1.1.0"}return o.prototype.decodeHtmlEntities=function(t){return t.replace(/&quot;|&#34;/g,'"').replace(/&apos;|&#39;/g,"'").replace(/&amp;/g,"&")},o.prototype.extractArrayLiteral=function(t,e){var r=new RegExp("[\"']?".concat(e,"[\"']?\\s*:")).exec(t);if(r){var n=t.indexOf("[",r.index+r[0].length);if(-1!==n)for(var a=0,i=!1,o="",s=n;s<t.length;s++){var c=t[s],u=s>0?t[s-1]:"";if(i)c===o&&"\\"!==u&&(i=!1);else if('"'!==c&&"'"!==c){if("["===c&&a++,"]"===c&&0===--a)return t.slice(n,s+1)}else i=!0,o=c}}},o.prototype.parseNovelsFromSource=function(t){if(!t)return[];var e=this.decodeHtmlEntities(t),r=this.extractArrayLiteral(e,"novels");if(!r)return[];try{var n=JSON.parse(r);if(!Array.isArray(n))return[];var i=[],o=new Set;return n.forEach((function(t){var e="object"==typeof t&&null!==t?t:{},r="string"==typeof(null==e?void 0:e.novelSlug)?e.novelSlug.trim():"",n="string"==typeof(null==e?void 0:e.novelName)?e.novelName.trim():"";if(r&&n){var s="novel/".concat(r);o.has(s)||(o.add(s),i.push({name:n,cover:"string"==typeof(null==e?void 0:e.novelImg)&&e.novelImg.trim()?e.novelImg:a.defaultCover,path:s}))}})),i}catch(t){return[]}},o.prototype.getCheerio=function(a){return t(this,void 0,void 0,(function(){var t,i;return e(this,(function(e){switch(e.label){case 0:return[4,(0,r.fetchApi)(a)];case 1:if(!(t=e.sent()).ok)throw new Error("Could not reach site ("+t.status+") try to open in webview.");return i=n.load,[4,t.text()];case 2:return[2,i.apply(void 0,[e.sent()])]}}))}))},o.prototype.popularNovels=function(i,o){return t(this,arguments,void 0,(function(t,i){var o,s,c,u,l,h,f=i.showLatestNovels;return e(this,(function(e){switch(e.label){case 0:return t>1?[2,[]]:[4,(0,r.fetchApi)(this.site+"home").then((function(t){return t.text()}))];case 1:if(o=e.sent(),s=(0,n.load)(o),f){if(c=s("section").filter((function(t,e){return s(e).find("h1").toArray().some((function(t){return/Novelas\s+Actualizadas/i.test(s(t).text().trim())}))})).first(),(u=this.parseNovelsFromSource(c.find('[x-data*="novels"]').first().attr("x-data"))).length)return[2,u];if((l=this.parseNovelsFromSource(c.html())).length)return[2,l]}return 0===(h=this.parseNovelsFromSource(o)).length&&s("ul.grid li").each((function(t,e){var r=s(e).find("h3").text().trim(),n=s(e).find("img").attr("src"),i=s(e).find("picture a").attr("href");r&&i&&h.push({name:r,cover:n||a.defaultCover,path:i.replace(/^\//,"")})})),[2,h]}}))}))},o.prototype.parseNovel=function(o){return t(this,void 0,void 0,(function(){var t,s,c,u,l,h,f;return e(this,(function(e){switch(e.label){case 0:return[4,(0,r.fetchApi)(this.site+o).then((function(t){return t.text()}))];case 1:return t=e.sent(),s=(0,n.load)(t),(c={path:o,name:s("h1").text().trim()}).cover=s("img.aspect-\\[2\\/3\\]").attr("src")||s("img").first().attr("src")||a.defaultCover,c.summary=s('div[x-ref="novelDescription"]').text().trim(),u=[],s("ul.flex.flex-wrap li").each((function(t,e){u.push(s(e).text().trim())})),c.genres=u.join(", "),c.author=s('a[href^="/translator/"]').text().trim()||"Pancho",(l=s('span:contains("Novela")').text()).includes("Activa")?c.status=i.NovelStatus.Ongoing:l.includes("Finalizada")?c.status=i.NovelStatus.Completed:c.status=i.NovelStatus.Unknown,h=s("[x-data]").toArray(),f=new Map,h.forEach((function(t){var e=s(t).attr("x-data")||"";if(e.includes("chapters:")){var r=e.match(/chapters\s*:\s*(\[[\s\S]*?\])\s*,\s*visibleChapters/);if(r)try{var n=r[1].replace(/\s+/g," ").replace(/([{,])\s*([a-zA-Z_$][\w$]*)\s*:/g,'$1"$2":').replace(/'/g,'"'),a=JSON.parse(n),i=o.split("/").filter(Boolean).pop()||"";a.forEach((function(t,e){if(t.chapterSlug&&t.chapterName){var r="novel/".concat(i,"/").concat(t.chapterSlug);f.has(r)||f.set(r,{name:t.chapterName,path:r,releaseTime:t.chapterDate,chapterNumber:t.chapterNumber})}}))}catch(t){}}})),c.chapters=Array.from(f.values()),c.chapters.reverse(),[2,c]}}))}))},o.prototype.parseChapter=function(r){return t(this,void 0,void 0,(function(){var t;return e(this,(function(e){switch(e.label){case 0:return[4,this.getCheerio(this.site+r)];case 1:return t=e.sent(),[2,t("p.mb-2").parent().first().html()||""]}}))}))},o.prototype.searchNovels=function(r){return t(this,void 0,void 0,(function(){var t,n;return e(this,(function(e){switch(e.label){case 0:return[4,this.getCheerio(this.site+"novel/search?q="+encodeURIComponent(r))];case 1:return t=e.sent(),n=[],t("div.mx-px, div.mx-1").each((function(e,r){var i=t(r).find("span.text-white").first().text().trim(),o=t(r).find("img").attr("src"),s=t(r).find('a[href^="/novel/"]').attr("href");i&&s&&n.push({name:i,cover:o||a.defaultCover,path:s.replace(/^\//,"")})})),[2,n]}}))}))},o}());exports.default=o;